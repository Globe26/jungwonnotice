<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>수행평가 일정 수정</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="container">
    <h1>수행평가 일정 수정</h1>
    <a href="./index.html" class="btn">← 목록으로</a>
  </header>

  <main class="container">
    <section class="card">
      <div class="grid g3">
        <div>
          <label class="label">반</label>
          <select id="classSelect" class="select">
            <option value="1">1반</option>
            <option value="2">2반</option>
            <option value="3">3반</option>
            <option value="4">4반</option>
            <option value="5">5반</option>
            <option value="6">6반</option>
            <option value="7">7반</option>
            <option value="8">8반</option>
            <option value="9">9반</option>
          </select>
        </div>
        <div>
          <label class="label">반 비밀번호</label>
          <input id="classPw" class="input" type="password" placeholder="반장 비번" />
        </div>
        <div class="row end">
          <button id="loadBtn" class="btn">불러오기</button>
        </div>
      </div>
      <div id="titleWrap" class="muted"></div>
      <div id="items"></div>
      <div class="row end"><button id="saveBtn" class="btn primary">저장</button></div>
      <div id="msg" class="muted"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjO0wwQQc8pDuQPurxVobABlKHAxDY2YA",
      authDomain: "jungwonjd2-1c79f.firebaseapp.com",
      projectId: "jungwonjd2-1c79f",
      storageBucket: "jungwonjd2-1c79f.firebasestorage.app",
      messagingSenderId: "962425903739",
      appId: "1:962425903739:web:de0c905dc285f566d3a0de",
      measurementId: "G-7LKGCZKMFW"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const postId = params.get('post');

    const titleWrap = document.getElementById('titleWrap');
    const itemsEl = document.getElementById('items');
    const msg = document.getElementById('msg');

    async function loadBase(){
      const pRef = doc(db, 'posts', postId);
      const s = await getDoc(pRef);
      if(!s.exists()){
        titleWrap.textContent = '포스트가 존재하지 않습니다.';
        return null;
      }
      const d = s.data();
      titleWrap.textContent = `제목: ${d.title} / 과목: ${d.subject||''}`;
      const schedules = Array.isArray(d.schedules) ? d.schedules : [];
      itemsEl.innerHTML = schedules.map(sc=>{
        return `
          <div class="row">
            <div class="mono" style="min-width:6rem">${sc.n}차시 : ${sc.text||''}</div>
            <input type="date" class="input" data-n="${sc.n}" data-key="date" />
            <select class="select" data-n="${sc.n}" data-key="period">
              <option value="1">1교시</option>
              <option value="2">2교시</option>
              <option value="3">3교시</option>
              <option value="4">4교시</option>
              <option value="5">5교시</option>
              <option value="6">6교시</option>
              <option value="7">7교시</option>
            </select>
          </div>`;
      }).join('');
      return d;
    }

    async function verifyPw(cls, pw){
      const ref = doc(db, 'classPasswords', cls);
      const s = await getDoc(ref);
      return s.exists() && s.data().password === pw;
    }

    async function loadExisting(cls){
      const ref = doc(db, `posts/${postId}/classSchedules/${cls}`);
      const s = await getDoc(ref);
      if(!s.exists()) return;
      const items = s.data().items || [];
      for(const it of items){
        const d = itemsEl.querySelector(`[data-n="${it.n}"][data-key="date"]`);
        const p = itemsEl.querySelector(`[data-n="${it.n}"][data-key="period"]`);
        if(d) d.value = it.date || '';
        if(p) p.value = String(it.period||'');
      }
    }

    document.getElementById('loadBtn').addEventListener('click', async ()=>{
      const cls = document.getElementById('classSelect').value;
      const pw = document.getElementById('classPw').value;
      if(!await verifyPw(cls, pw)){
        msg.textContent = '반 비밀번호가 올바르지 않습니다.';
        return;
      }
      msg.textContent = '불러왔습니다.';
      await loadExisting(cls);
    });

    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      const cls = document.getElementById('classSelect').value;
      const pw = document.getElementById('classPw').value;
      if(!await verifyPw(cls, pw)){
        msg.textContent = '반 비밀번호가 올바르지 않습니다.';
        return;
      }
      const dates = itemsEl.querySelectorAll('[data-key="date"]');
      const periods = itemsEl.querySelectorAll('[data-key="period"]');
      const obj = {};
      dates.forEach(d=>{
        const n = d.dataset.n;
        obj[n] = obj[n]||{}; obj[n].date = d.value || null;
      });
      periods.forEach(p=>{
        const n = p.dataset.n;
        obj[n] = obj[n]||{}; obj[n].period = Number(p.value||0);
      });
      const items = Object.entries(obj).map(([n,v])=>({ n:Number(n), date:v.date, period:v.period }));
      const ref = doc(db, `posts/${postId}/classSchedules/${cls}`);
      await setDoc(ref, { items, updatedAt: serverTimestamp() });
      msg.textContent = '저장 완료!';
    });

    // 초기 로드: 기본 폼 채우기
    loadBase();
  </script>
</body>
</html>