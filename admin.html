<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리자 패널</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    #postList .card {
      border: 1px solid #ccc; border-radius: 8px; padding: 10px;
      margin-bottom: 12px; display: flex; flex-direction: column;
      align-items: flex-start; gap: 6px;
    }
    #previewWrap img { max-width: 200px; border-radius: 8px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header class="container">
    <h1>관리자 패널</h1>
    <a href="./index.html" class="btn">← 메인으로</a>
  </header>

  <main class="container">
    <!-- 로그인 게이트 -->
    <section id="gate">
      <p>관리자 비밀번호를 입력하세요.</p>
      <input id="adminPw" class="input" type="password" placeholder="비밀번호"/>
      <button id="enterBtn" class="btn">입장</button>
      <div id="gateMsg" class="error"></div>
    </section>

    <!-- 관리자 기능 -->
    <section id="panel" class="hidden">
      <h2>반장 비밀번호 설정</h2>
      <div class="grid g2">
        <div>
          <label class="label">반 선택</label>
          <select id="classSelect" class="select">
            <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
            <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
            <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
          </select>
        </div>
        <div>
          <label class="label">해당 반 비밀번호</label>
          <input id="classPw" class="input" type="text" placeholder="예: 1234" />
        </div>
      </div>
      <button id="saveClassPw" class="btn">저장</button>
      <div id="classPwMsg" class="muted"></div>

      <hr/>

      <h2>게시글 작성</h2>
      <div class="row">
        <label class="label">카테고리</label>
        <select id="category" class="select">
          <option value="general">전체 공지</option>
          <option value="event">행사</option>
          <option value="assessment">수행평가</option>
          <option value="class_notice">반별 공지</option>
        </select>
      </div>

      <div id="targetClassWrap" class="row hidden">
        <label class="label">대상 반</label>
        <select id="targetClass" class="select">
          <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
          <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
          <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
        </select>
      </div>

      <div class="row"><label class="label">제목</label><input id="title" class="input" type="text" /></div>
      <div class="row"><label class="label">내용</label><textarea id="content" class="input" rows="5"></textarea></div>

      <div id="eventWrap" class="row hidden">
        <label class="label">행사일</label>
        <input id="eventDate" class="input" type="date" />
      </div>

      <div id="assessmentWrap" class="hidden">
        <div class="row">
          <label class="label">과목</label>
          <select id="subject" class="select">
            <option>국어</option><option>수학</option><option>영어</option><option>통합사회</option>
            <option>통합과학</option><option>한국사</option><option>기술가정</option><option>한문</option>
            <option>미술</option><option>체육</option><option>과학탐구실험</option><option>기타</option>
          </select>
        </div>
        <div class="row">
          <label class="label">일정(차시)</label>
          <div id="scheduleList"></div>
          <button id="addSchedule" class="btn ghost">차시 추가</button>
        </div>
      </div>

      <div class="row"><label class="label">사진(선택)</label><input id="image" type="file" accept="image/*" /></div>
      <div class="row"><label class="label">파일(선택)</label><input id="file" type="file" /></div>

      <button id="publish" class="btn primary">게시</button>
      <div id="pubMsg" class="muted"></div>
    </section>

    <!-- 수정 / 삭제 탭 -->
    <section id="editSection" class="hidden"></section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getFirestore, doc, setDoc, collection, addDoc, serverTimestamp, getDocs, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjO0wwQQc8pDuQPurxVobABlKHAxDY2YA",
      authDomain: "jungwonjd2-1c79f.firebaseapp.com",
      projectId: "jungwonjd2-1c79f",
      storageBucket: "jungwonjd2-1c79f.appspot.com",
      messagingSenderId: "962425903739",
      appId: "1:962425903739:web:de0c905dc285f566d3a0de",
      measurementId: "G-7LKGCZKMFW"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

import { uploadBytes } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

const storage1 = getStorage();

async function uploadImage(file, path) {
  const storageRef = ref(storage1, path);
  const snapshot = await uploadBytes(storageRef, file);
  const url = await getDownloadURL(snapshot.ref);
  return url;
}
    // 로그인 게이트
    const gate = document.getElementById('gate');
    const panel = document.getElementById('panel');
    const editSection = document.getElementById('editSection');
    const gateMsg = document.getElementById('gateMsg');
    document.getElementById('enterBtn').addEventListener('click', ()=>{
      const v=document.getElementById('adminPw').value;
      if(v==='0922'){ gate.classList.add('hidden'); panel.classList.remove('hidden'); editSection.classList.remove('hidden'); }
      else { gateMsg.textContent='비밀번호가 올바르지 않습니다.'; }
    });

    // 게시 버튼
    document.getElementById('publish').addEventListener('click', async ()=>{
      const btn=document.getElementById('publish');
      const msg=document.getElementById('pubMsg');
      const category=document.getElementById('category').value;
      const title=document.getElementById('title').value.trim();
      const content=document.getElementById('content').value.trim();
      if(!title){msg.textContent='제목은 필수입니다.';return;}

      btn.disabled=true;
      msg.textContent='게시 중...';

      const image=document.getElementById('image').files[0];
      const file=document.getElementById('file').files[0];
      const payload={
        category,title,content,createdAt:serverTimestamp(),
        targetClass:category==='class_notice'?document.getElementById('targetClass').value:'all'
      };

      if(category==='event')payload.eventDate=document.getElementById('eventDate').value;
      payload.imageUrl=await uploadIfNeeded(image,'images');
      payload.fileUrl=await uploadIfNeeded(file,'files');

      await addDoc(collection(db,'posts'),payload);
      btn.disabled=false;
      msg.textContent='';
      alert('게시 완료!');
    });

    /* ===================== 수정탭 ===================== */
    editSection.innerHTML=`
      <h2>게시글 수정 / 삭제</h2>
      <div class="row">
        <label class="label">카테고리 선택</label>
        <select id="editCategory" class="select">
          <option value="general">전체 공지</option>
          <option value="event">행사</option>
          <option value="assessment">수행평가</option>
          <option value="class_notice">반별 공지</option>
        </select>
      </div>
      <div id="postList" class="row"></div>
      <div id="editForm" class="hidden">
        <h3>게시글 수정</h3>
        <input id="editTitle" class="input" placeholder="제목" />
        <textarea id="editContent" class="input" rows="5" placeholder="내용"></textarea>
        <div id="previewWrap"></div>
        <input id="editImage" type="file" accept="image/*" />
        <input id="editFile" type="file" />
        <button id="saveEdit" class="btn primary">수정 저장</button>
        <button id="cancelEdit" class="btn ghost">취소</button>
        <div id="editMsg" class="muted"></div>
      </div>
    `;

    const editCategory=document.getElementById('editCategory');
    const postList=document.getElementById('postList');
    const editForm=document.getElementById('editForm');
    const editTitle=document.getElementById('editTitle');
    const editContent=document.getElementById('editContent');
    const editImage=document.getElementById('editImage');
    const editFile=document.getElementById('editFile');
    const previewWrap=document.getElementById('previewWrap');
    const editMsg=document.getElementById('editMsg');
    let currentEditId=null;

    editCategory.addEventListener('change',async()=>{
      postList.innerHTML='<p>로딩 중...</p>';
      const cat=editCategory.value;
      const qSnap=await getDocs(collection(db,'posts'));
      const filtered=[];
      qSnap.forEach(docSnap=>{
        const d=docSnap.data();
        if(d.category===cat)filtered.push({id:docSnap.id,...d});
      });
      if(filtered.length===0){postList.innerHTML='<p>해당 카테고리 게시글 없음.</p>';return;}
      postList.innerHTML='';
      filtered.forEach(d=>{
        const item=document.createElement('div');
        item.className='card';
        item.innerHTML=`
          <b>${d.title}</b>
          <small>${d.content.substring(0,60)}...</small>
          <div style="margin-top:5px;">
            <button class="btn small" data-edit="${d.id}">수정</button>
            <button class="btn ghost small" data-del="${d.id}">삭제</button>
          </div>`;
        postList.appendChild(item);
      });

      postList.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click',async()=>{
          const id=btn.dataset.edit;currentEditId=id;
          const snap=await getDoc(doc(db,'posts',id));const data=snap.data();
          editTitle.value=data.title||'';editContent.value=data.content||'';
          previewWrap.innerHTML=data.imageUrl?`<img src="${data.imageUrl}">`:'';
          editForm.classList.remove('hidden');
          window.scrollTo({top:editForm.offsetTop,behavior:'smooth'});
        });
      });

      postList.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click',async()=>{
          const id=btn.dataset.del;
          if(confirm('정말 이 게시글을 삭제하시겠습니까? 삭제 후 복구할 수 없습니다.')){
            await deleteDoc(doc(db,'posts',id));
            btn.closest('.card').remove();
            alert('삭제 완료!');
          }
        });
      });
    });

    document.getElementById('saveEdit').addEventListener('click',async()=>{
      if(!currentEditId)return;
      const title=editTitle.value.trim();
      const content=editContent.value.trim();
      const img=await uploadIfNeeded(editImage.files[0],'images');
      const file=await uploadIfNeeded(editFile.files[0],'files');
      const payload={title,content,updatedAt:serverTimestamp()};
      if(img)payload.imageUrl=img;
      if(file)payload.fileUrl=file;
      await updateDoc(doc(db,'posts',currentEditId),payload);
      editMsg.textContent='수정 완료!';
      editForm.classList.add('hidden');
      postList.innerHTML='';
    });
    document.getElementById('cancelEdit').addEventListener('click',()=>editForm.classList.add('hidden'));
  </script>
</body>
</html>


