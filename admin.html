<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê´€ë¦¬ì íŒ¨ë„</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    #postList .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }
    #previewWrap img {
      max-width: 200px;
      border-radius: 8px;
      margin-bottom: 10px;
      display:block;
    }
    .hidden { display: none; }
    .row.gap-8 { gap: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f0f0f0; font-size:12px; }
  </style>
</head>
<body>
  <header class="container">
    <h1>ê´€ë¦¬ì íŒ¨ë„</h1>
    <a href="./index.html" class="btn">â† ë©”ì¸ìœ¼ë¡œ</a>
  </header>

  <main class="container">
    <!-- ë¡œê·¸ì¸ ê²Œì´íŠ¸ -->
    <section id="gate">
      <p>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input id="adminPw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"/>
      <button id="enterBtn" class="btn">ì…ì¥</button>
      <div id="gateMsg" class="error"></div>
    </section>

    <!-- ê´€ë¦¬ì ê¸°ëŠ¥ -->
    <section id="panel" class="hidden">
      <h2>ë°˜ì¥ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h2>
      <div class="grid g2">
        <div>
          <label class="label">ë°˜ ì„ íƒ</label>
          <select id="classSelect" class="select">
            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
            <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
            <option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option>
          </select>
        </div>
        <div>
          <label class="label">í•´ë‹¹ ë°˜ ë¹„ë°€ë²ˆí˜¸</label>
          <input id="classPw" class="input" type="text" placeholder="ì˜ˆ: 1234" />
        </div>
      </div>
      <button id="saveClassPw" class="btn">ì €ì¥</button>
      <div id="classPwMsg" class="muted"></div>

      <hr/>

      <h2>ê²Œì‹œê¸€ ì‘ì„±</h2>
      <div class="row">
        <label class="label">ì¹´í…Œê³ ë¦¬</label>
        <select id="category" class="select">
          <option value="general">ì „ì²´ ê³µì§€</option>
          <option value="event">í–‰ì‚¬</option>
          <option value="assessment">ìˆ˜í–‰í‰ê°€</option>
          <option value="class_notice">ë°˜ë³„ ê³µì§€</option>
        </select>
      </div>

      <!-- ìˆ˜í–‰í‰ê°€ ê³¼ëª© -->
      <div id="subjectWrap" class="row hidden">
        <label class="label">ê³¼ëª©</label>
        <select id="subjectSelect" class="select">
          <option>êµ­ì–´</option><option>ìˆ˜í•™</option><option>ì˜ì–´</option>
          <option>í†µí•©ì‚¬íšŒ</option><option>í†µí•©ê³¼í•™</option><option>í•œêµ­ì‚¬</option>
          <option>ê¸°ìˆ ê°€ì •</option><option>í•œë¬¸</option><option>ë¯¸ìˆ </option>
          <option>ì²´ìœ¡</option><option>ê³¼í•™íƒêµ¬ì‹¤í—˜</option><option>ê¸°íƒ€</option>
        </select>
      </div>

      <!-- âœ… ìˆ˜í–‰í‰ê°€ ì°¨ì‹œ(ì¼ì •) ë³µêµ¬ -->
      <div id="assessmentWrap" class="hidden">
        <div class="row">
          <label class="label">ì¼ì •(ì°¨ì‹œ)</label>
          <div id="scheduleList"></div>
          <button id="addSchedule" class="btn ghost">ì°¨ì‹œ ì¶”ê°€</button>
        </div>
      </div>

      <!-- ë°˜ë³„ ê³µì§€ ëŒ€ìƒ ë°˜ -->
      <div id="targetClassWrap" class="row hidden">
        <label class="label">ëŒ€ìƒ ë°˜</label>
        <select id="targetClass" class="select">
          <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
          <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
          <option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option>
        </select>
      </div>

      <div class="row"><label class="label">ì œëª©</label><input id="title" class="input" type="text" /></div>
      <div class="row"><label class="label">ë‚´ìš©</label><textarea id="content" class="input" rows="5"></textarea></div>

      <div id="eventWrap" class="row hidden">
        <label class="label">í–‰ì‚¬ì¼</label>
        <input id="eventDate" class="input" type="date" />
      </div>

      <!-- âœ… ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œ ê°€ëŠ¥ -->
      <div class="row"><label class="label">ì‚¬ì§„(ì„ íƒ, ì—¬ëŸ¬ ì¥)</label><input id="image" type="file" accept="image/*" multiple /></div>
      <div class="row"><label class="label">íŒŒì¼(ì„ íƒ)</label><input id="file" type="file" /></div>

      <button id="publish" class="btn primary">ê²Œì‹œ</button>
      <div id="pubMsg" class="muted"></div>
    </section>

    <!-- ìˆ˜ì • / ì‚­ì œ íƒ­ -->
    <section id="editSection" class="hidden"></section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import {
      getFirestore, doc, setDoc, collection, addDoc, serverTimestamp,
      getDocs, deleteDoc, updateDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjO0wwQQc8pDuQPurxVobABlKHAxDY2YA",
      authDomain: "jungwonjd2-1c79f.firebaseapp.com",
      projectId: "jungwonjd2-1c79f",
      storageBucket: "jungwonjd2-1c79f.appspot.com",
      messagingSenderId: "962425903739",
      appId: "1:962425903739:web:de0c905dc285f566d3a0de",
      measurementId: "G-7LKGCZKMFW"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // ğŸ”’ ë¡œê·¸ì¸ ê²Œì´íŠ¸
    const gate=document.getElementById('gate');
    const panel=document.getElementById('panel');
    const editSection=document.getElementById('editSection');
    const gateMsg=document.getElementById('gateMsg');
    document.getElementById('enterBtn').addEventListener('click',()=>{
      const v=document.getElementById('adminPw').value;
      if(v==='0922'){ gate.classList.add('hidden'); panel.classList.remove('hidden'); editSection.classList.remove('hidden'); }
      else { gateMsg.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; }
    });

    // âœ… ì´ë¯¸ì§€/íŒŒì¼ Base64 ì—…ë¡œë” (ì´ë¯¸ì§€ ì••ì¶•)
    async function toBase64(file){ // ì¼ë°˜ íŒŒì¼
      if(!file) return null;
      return await new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>resolve(e.target.result);
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }
    async function compressImage(file){ // ì´ë¯¸ì§€ ì••ì¶•
      return await new Promise((resolve)=>{
        const reader=new FileReader();
        reader.onload=e=>{
          const img=new Image();
          img.onload=()=>{
            const canvas=document.createElement('canvas');
            const ctx=canvas.getContext('2d');
            const scale=Math.min(800/img.width,800/img.height,1);
            canvas.width=img.width*scale;
            canvas.height=img.height*scale;
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
            resolve(canvas.toDataURL('image/jpeg',0.7));
          };
          img.src=e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
    async function uploadManyImages(fileList){
      if(!fileList || fileList.length===0) return [];
      const files=[...fileList].slice(0,10); // ì•ˆì „ìƒ ìµœëŒ€ 10ì¥ ì œí•œ
      const out=[];
      for(const f of files){
        if(f.type.startsWith('image/')) out.push(await compressImage(f));
      }
      return out;
    }

    // ğŸ§­ ì¹´í…Œê³ ë¦¬ë³„ ì…ë ¥ í•„ë“œ í‘œì‹œ ì œì–´
    const categorySel=document.getElementById('category');
    const eventWrap=document.getElementById('eventWrap');
    const subjectWrap=document.getElementById('subjectWrap');
    const targetClassWrap=document.getElementById('targetClassWrap');
    const assessmentWrap=document.getElementById('assessmentWrap');
    function refreshVisibility(){
      const v=categorySel.value;
      eventWrap.classList.toggle('hidden',v!=='event');
      subjectWrap.classList.toggle('hidden',v!=='assessment');
      assessmentWrap.classList.toggle('hidden',v!=='assessment');
      targetClassWrap.classList.toggle('hidden',v!=='class_notice');
    }
    categorySel.addEventListener('change',refreshVisibility);
    refreshVisibility();

    // âœ… ìˆ˜í–‰í‰ê°€ ì°¨ì‹œ UI
    const scheduleList=document.getElementById('scheduleList');
    let scheduleN=0;
    function renderScheduleItem(n,text=''){
      const row=document.createElement('div');
      row.className='row gap-8';
      row.innerHTML=`
        <div class="mono" style="min-width:64px">${n}ì°¨ì‹œ :</div>
        <input class="input flex1" data-n="${n}" placeholder="ì˜ˆ: ë³´ê³ ì„œ ì‘ì„± / ë°œí‘œ / í€´ì¦ˆ" value="${text}" />
        <button class="btn ghost" data-remove="${n}">ì‚­ì œ</button>`;
      scheduleList.appendChild(row);
      row.querySelector('[data-remove]').addEventListener('click',()=>row.remove());
    }
    function addSchedule(){ scheduleN+=1; renderScheduleItem(scheduleN); }
    document.getElementById('addSchedule').addEventListener('click', addSchedule);
    // ê¸°ë³¸ 1ê°œ
    addSchedule();

    // ğŸ“ ê²Œì‹œê¸€ ì‘ì„±
    document.getElementById('publish').addEventListener('click',async()=>{
      const btn=document.getElementById('publish');
      const msg=document.getElementById('pubMsg');
      const category=categorySel.value;
      const title=document.getElementById('title').value.trim();
      const content=document.getElementById('content').value.trim();
      if(!title){msg.textContent='ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.';return;}
      btn.disabled=true; msg.textContent='ê²Œì‹œ ì¤‘...';

      try{
        // ì´ë¯¸ì§€ ì—¬ëŸ¬ ì¥
        const imageFiles=document.getElementById('image').files;
        const imageUrls=await uploadManyImages(imageFiles);
        // ì²¨ë¶€ íŒŒì¼(ë‹¨ì¼, ì„ íƒ)
        const file=document.getElementById('file').files[0];
        const fileUrl=await toBase64(file);

        const payload={category,title,content,createdAt:serverTimestamp()};
        if(category==='assessment'){
          payload.subject=document.getElementById('subjectSelect').value;
          // ì°¨ì‹œ ìˆ˜ì§‘
          const inputs=[...scheduleList.querySelectorAll('input[data-n]')];
          const schedules=inputs.map(inp=>({ n:Number(inp.dataset.n), text:inp.value.trim() }))
                                .filter(it=>it.text!==''||it.n); // ë¹„ì–´ë„ n ë³´ì¡´
          payload.schedules = schedules.length? schedules : [{n:1,text:''}];
        }
        if(category==='class_notice'){
          payload.targetClass=document.getElementById('targetClass').value;
        }else{
          payload.targetClass='all';
        }
        if(category==='event'){
          payload.eventDate=document.getElementById('eventDate').value || null;
        }

        // ì´ë¯¸ì§€ ì €ì¥ (ëŒ€í‘œ 1ì¥ + ë°°ì—´)
        if(imageUrls.length>0){
          payload.imageUrls = imageUrls;
          payload.imageUrl  = imageUrls[0];
        } else {
          payload.imageUrls = [];
          payload.imageUrl  = null;
        }
        payload.fileUrl = fileUrl || null;

        await addDoc(collection(db,'posts'),payload);
        alert('ê²Œì‹œ ì™„ë£Œ!');
      }catch(err){
        console.error(err);
        alert('ê²Œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }finally{
        btn.disabled=false; msg.textContent='';
      }
    });

    // ğŸ§© ìˆ˜ì • / ì‚­ì œ íƒ­
    editSection.innerHTML=`
      <h2>ê²Œì‹œê¸€ ìˆ˜ì • / ì‚­ì œ</h2>
      <div class="row">
        <label class="label">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
        <select id="editCategory" class="select">
          <option value="general">ì „ì²´ ê³µì§€</option>
          <option value="event">í–‰ì‚¬</option>
          <option value="assessment">ìˆ˜í–‰í‰ê°€</option>
          <option value="class_notice">ë°˜ë³„ ê³µì§€</option>
        </select>
      </div>
      <div id="postList" class="row"></div>
      <div id="editForm" class="hidden">
        <h3>ê²Œì‹œê¸€ ìˆ˜ì •</h3>
        <input id="editTitle" class="input" placeholder="ì œëª©" />
        <textarea id="editContent" class="input" rows="5" placeholder="ë‚´ìš©"></textarea>

        <div class="muted">í˜„ì¬ ëŒ€í‘œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</div>
        <div id="previewWrap"></div>

        <div class="row"><label class="label">ìƒˆ ì´ë¯¸ì§€(ì—¬ëŸ¬ ì¥ ì„ íƒ ì‹œ êµì²´)</label>
          <input id="editImages" type="file" accept="image/*" multiple />
        </div>
        <div class="row"><label class="label">ìƒˆ íŒŒì¼(ì„ íƒ)</label>
          <input id="editFile" type="file" />
        </div>

        <button id="saveEdit" class="btn primary">ìˆ˜ì • ì €ì¥</button>
        <button id="cancelEdit" class="btn ghost">ì·¨ì†Œ</button>
        <div id="editMsg" class="muted"></div>
      </div>
    `;

    const editCategory=document.getElementById('editCategory');
    const postList=document.getElementById('postList');
    const editForm=document.getElementById('editForm');
    const editTitle=document.getElementById('editTitle');
    const editContent=document.getElementById('editContent');
    const editImages=document.getElementById('editImages');
    const editFile=document.getElementById('editFile');
    const previewWrap=document.getElementById('previewWrap');
    const editMsg=document.getElementById('editMsg');
    let currentEditId=null;
    let currentDocCache=null;

    editCategory.addEventListener('change',async()=>{
      postList.innerHTML='<p>ë¡œë”© ì¤‘...</p>';
      const cat=editCategory.value;
      const qSnap=await getDocs(collection(db,'posts'));
      const filtered=[];
      qSnap.forEach(docSnap=>{
        const d=docSnap.data();
        if(d.category===cat)filtered.push({id:docSnap.id,...d});
      });
      if(filtered.length===0){postList.innerHTML='<p>í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ê²Œì‹œê¸€ ì—†ìŒ.</p>';return;}
      postList.innerHTML='';
      filtered.forEach(d=>{
        const item=document.createElement('div');
        item.className='card';
        const preview = d.imageUrl ? `<img src="${d.imageUrl}" style="max-width:120px;border-radius:6px;margin:6px 0;">` : '';
        item.innerHTML=`
          <b>${d.title}</b>
          <small>${(d.content||'').substring(0,60)}...</small>
          ${preview}
          <div style="margin-top:5px;">
            <button class="btn small" data-edit="${d.id}">ìˆ˜ì •</button>
            <button class="btn ghost small" data-del="${d.id}">ì‚­ì œ</button>
          </div>`;
        postList.appendChild(item);
      });

      // ìˆ˜ì •
      postList.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click',async()=>{
          const id=btn.dataset.edit; currentEditId=id;
          const snap=await getDoc(doc(db,'posts',id));
          const data=snap.data(); currentDocCache=data||{};
          editTitle.value=data.title||''; editContent.value=data.content||'';
          previewWrap.innerHTML = data.imageUrl ? `<img src="${data.imageUrl}">` : '<div class="muted">ì´ë¯¸ì§€ ì—†ìŒ</div>';
          editImages.value=''; editFile.value='';
          editForm.classList.remove('hidden');
          window.scrollTo({top:editForm.offsetTop,behavior:'smooth'});
        });
      });

      // ì‚­ì œ
      postList.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click',async()=>{
          const id=btn.dataset.del;
          if(confirm('ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚­ì œ í›„ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')){
            await deleteDoc(doc(db,'posts',id));
            btn.closest('.card').remove();
            alert('ì‚­ì œ ì™„ë£Œ!');
          }
        });
      });
    });

    document.getElementById('saveEdit').addEventListener('click',async()=>{
      if(!currentEditId)return;
      const title=editTitle.value.trim();
      const content=editContent.value.trim();

      // ìƒˆ ì´ë¯¸ì§€ ì„ íƒì‹œ êµì²´, ì•„ë‹ˆë©´ ê¸°ì¡´ ìœ ì§€
      let imageUrls = currentDocCache?.imageUrls || [];
      let imageUrl  = currentDocCache?.imageUrl  ?? null;

      if(editImages.files && editImages.files.length>0){
        imageUrls = await uploadManyImages(editImages.files);
        imageUrl  = imageUrls.length? imageUrls[0] : null;
      }

      // ìƒˆ íŒŒì¼ ì„ íƒì‹œ êµì²´, ì•„ë‹ˆë©´ ê¸°ì¡´ ìœ ì§€
      let fileUrl = currentDocCache?.fileUrl ?? null;
      if(editFile.files && editFile.files[0]){
        fileUrl = await toBase64(editFile.files[0]);
      }

      const payload={ title, content, updatedAt:serverTimestamp() };
      // ì´ë¯¸ì§€/íŒŒì¼ë§Œ ë³€ê²½ëœ ê²½ìš°ì—ë„ merge ë˜ë„ë¡ ì„ íƒì  ì¶”ê°€
      payload.imageUrls = imageUrls;
      payload.imageUrl  = imageUrl;
      payload.fileUrl   = fileUrl;

      await updateDoc(doc(db,'posts',currentEditId),payload);
      editMsg.textContent='ìˆ˜ì • ì™„ë£Œ!';
      editForm.classList.add('hidden');
      postList.innerHTML='';
    });

    document.getElementById('cancelEdit').addEventListener('click',()=>editForm.classList.add('hidden'));
  </script>
</body>
</html>
