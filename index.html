<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¤‘ì›ê³  1í•™ë…„ ê³µì§€ ì•Œë¦¬ë¯¸</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .card {border:1px solid #ccc;border-radius:10px;padding:10px;margin-bottom:12px;}
    .card img {max-width:100%;border-radius:8px;margin-top:8px;}
    .btn.small{font-size:.85em;padding:4px 8px;margin-left:5px;}
    .edit-box{border:1px solid #ccc;padding:8px;border-radius:6px;margin-top:8px;}
    #newNoticeBox{border:1px solid #ddd;padding:10px;margin-bottom:10px;border-radius:8px;}
  </style>
</head>
<body>
  <header class="container">
    <h1>ì¤‘ì›ê³  1í•™ë…„ ê³µì§€ ì•Œë¦¬ë¯¸</h1>
    <div class="row">
      <label for="classSelect" class="label">ë°˜ ì„ íƒ</label>
      <select id="classSelect" class="select">
        <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
        <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
        <option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option>
      </select>
    </div>
  </header>

  <nav class="tabs container" id="categoryTabs">
    <button data-cat="general" class="tab active">ì „ì²´ ê³µì§€</button>
    <button data-cat="event" class="tab">í–‰ì‚¬</button>
    <button data-cat="assessment" class="tab">ìˆ˜í–‰í‰ê°€</button>
    <button data-cat="class_notice" class="tab">ë°˜ë³„ ê³µì§€</button>
  </nav>

  <section class="container filters">
    <input id="searchInput" class="input" type="search" placeholder="ì œëª©+ë‚´ìš© ê²€ìƒ‰" />
  </section>

  <main class="container" id="list"></main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, addDoc, updateDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjO0wwQQc8pDuQPurxVobABlKHAxDY2YA",
      authDomain: "jungwonjd2-1c79f.firebaseapp.com",
      projectId: "jungwonjd2-1c79f",
      storageBucket: "jungwonjd2-1c79f.firebasestorage.app",
      messagingSenderId: "962425903739",
      appId: "1:962425903739:web:de0c905dc285f566d3a0de",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tabs=document.getElementById('categoryTabs');
    const list=document.getElementById('list');
    const classSelect=document.getElementById('classSelect');
    const searchInput=document.getElementById('searchInput');
    let currentCat='general';
    let classPwCache={};

    // ğŸ”— URL ìë™ ë§í¬ ì²˜ë¦¬
    function linkify(text){
      const urlRegex=/(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex,'<a href="$1" target="_blank">$1</a>');
    }

    // ğŸ–¼ï¸ ì´ë¯¸ì§€ íŒŒì¼ base64 ë³€í™˜
    async function fileToBase64(file){
      if(!file) return null;
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>resolve(e.target.result);
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    function setActiveTab(cat){
      [...tabs.querySelectorAll('.tab')].forEach(b=>b.classList.toggle('active',b.dataset.cat===cat));
      currentCat=cat;
      render();
    }
    tabs.addEventListener('click',(e)=>{
      const b=e.target.closest('button[data-cat]');
      if(!b)return;
      setActiveTab(b.dataset.cat);
    });
    classSelect.addEventListener('change',render);
    searchInput.addEventListener('input',render);

    async function fetchPosts(){
      const postsRef=collection(db,'posts');
      let q;
      if(currentCat==='class_notice'){
        q=query(postsRef,where('category','==','class_notice'),where('targetClass','==',classSelect.value),orderBy('createdAt','desc'));
      }else{
        q=query(postsRef,where('category','==',currentCat),orderBy('createdAt','desc'));
      }
      const snap=await getDocs(q);
      return snap.docs.map(d=>({id:d.id,...d.data()}));
    }

    async function verifyClassPw(){
      const cls=classSelect.value;
      if(classPwCache[cls]) return true;
      const pw=prompt(`${cls}ë°˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”`);
      if(!pw)return false;
      const ref=doc(db,'classPasswords',cls);
      const snap=await getDoc(ref);
      if(!snap.exists()||snap.data().password!==pw){alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');return false;}
      classPwCache[cls]=true;
      return true;
    }

    async function render(){
      list.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      const posts=await fetchPosts();
      const q=searchInput.value.trim().toLowerCase();

      let html='';
      // ë°˜ë³„ê³µì§€ì¼ ë•Œ ì‘ì„± ë°•ìŠ¤ í‘œì‹œ
      if(currentCat==='class_notice'){
        html+=`
        <div id="newNoticeBox">
          <h3>ìƒˆ ë°˜ë³„ ê³µì§€ ì‘ì„±</h3>
          <input id="newTitle" class="input" placeholder="ì œëª©" />
          <textarea id="newContent" class="input" rows="4" placeholder="ë‚´ìš©"></textarea>
          <div class="row"><label class="label">ì‚¬ì§„(ì„ íƒ)</label><input id="newImage" type="file" accept="image/*"></div>
          <button id="newSubmit" class="btn primary">ê²Œì‹œ</button>
          <div id="newMsg" class="muted"></div>
        </div>`;
      }

      posts.forEach(p=>{
        if(q){
          const hay=(p.title+p.content).toLowerCase();
          if(!hay.includes(q))return;
        }
        html+=`
        <article class="card" data-id="${p.id}">
          <h3>${p.title}</h3>
          <p>${linkify(p.content||'').replace(/\n/g,'<br>')}</p>
          ${p.imageUrl?`<img src="${p.imageUrl}" alt="">`:''}
          <div class="row end">
            ${currentCat==='class_notice'?`<button class="btn small" data-edit="${p.id}">ìˆ˜ì •</button>`:''}
          </div>
        </article>`;
      });
      list.innerHTML=html||'<div class="empty">ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

      // ì‘ì„± ì´ë²¤íŠ¸
      if(currentCat==='class_notice'){
        document.getElementById('newSubmit').addEventListener('click',async()=>{
          if(!await verifyClassPw())return;
          const title=document.getElementById('newTitle').value.trim();
          const content=document.getElementById('newContent').value.trim();
          const file=document.getElementById('newImage').files[0];
          if(!title||!content){alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
          const imgData=await fileToBase64(file);
          await addDoc(collection(db,'posts'),{
            title,content,category:'class_notice',
            targetClass:classSelect.value,
            imageUrl:imgData||null,
            createdAt:serverTimestamp()
          });
          alert('ê²Œì‹œ ì™„ë£Œ!');
          render();
        });

        // ìˆ˜ì • ê¸°ëŠ¥
        list.querySelectorAll('[data-edit]').forEach(btn=>{
          btn.addEventListener('click',async()=>{
            if(!await verifyClassPw())return;
            const id=btn.dataset.edit;
            const card=btn.closest('.card');
            const t=card.querySelector('h3').textContent;
            const c=card.querySelector('p').textContent;

            card.innerHTML=`
              <div class="edit-box">
                <input id="editTitle" class="input" value="${t}">
                <textarea id="editContent" class="input">${c}</textarea>
                <div class="row"><label>ì‚¬ì§„(ì„ íƒ)</label><input id="editImage" type="file" accept="image/*"></div>
                <button id="saveBtn" class="btn primary">ì €ì¥</button>
                <button id="cancelBtn" class="btn ghost">ì·¨ì†Œ</button>
              </div>`;

            card.querySelector('#saveBtn').addEventListener('click',async()=>{
              const nt=card.querySelector('#editTitle').value.trim();
              const nc=card.querySelector('#editContent').value.trim();
              const nf=card.querySelector('#editImage').files[0];
              const img=await fileToBase64(nf);
              const payload={title:nt,content:nc,updatedAt:serverTimestamp()};
              if(img)payload.imageUrl=img;
              await updateDoc(doc(db,'posts',id),payload);
              alert('ìˆ˜ì • ì™„ë£Œ!');
              render();
            });
            card.querySelector('#cancelBtn').addEventListener('click',()=>render());
          });
        });
      }
    }

    setActiveTab('general');
  </script>
</body>
</html>
