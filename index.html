<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>중원고 1학년 공지 알리미</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="icon" type="image/svg+xml" href="./icon.svg" />
  <style>
    .card-img {max-width:100%;border-radius:8px;margin-top:8px;cursor:pointer;}
    .img-carousel {position:relative;max-width:100%;margin-top:8px;}
    .img-carousel img{width:100%;border-radius:8px;cursor:pointer;}
    .img-carousel button{
      position:absolute;top:50%;transform:translateY(-50%);
      background:rgba(0,0,0,0.5);color:#fff;border:none;
      padding:6px 10px;border-radius:50%;cursor:pointer;opacity:.8;
    }
    .img-prev{left:8px;} .img-next{right:8px;}
    .img-count{position:absolute;bottom:5px;right:10px;
      background:rgba(0,0,0,0.5);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;}
    .btn.small{font-size:.85em;padding:4px 8px;margin-left:5px;}
    #newNoticeBox{border:1px solid #ccc;border-radius:10px;padding:10px;margin-bottom:12px;}
    .edit-box{border:1px solid #ccc;padding:8px;border-radius:6px;margin-top:8px;}
    .pill{display:inline-block;background:#eee;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .row.end{display:flex;gap:8px;justify-content:flex-end;align-items:center;margin-top:8px;}
  </style>
</head>
<body>
  <header class="container">
    <img src="./icon.svg" alt="로고" style="height:40px;vertical-align:middle;margin-right:10px;">
    <h1 style="display:inline-block;vertical-align:middle;">중원고 1학년 공지 알리미</h1>
    <div class="row">
      <label for="classSelect" class="label">반 선택</label>
      <select id="classSelect" class="select">
        <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
        <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
        <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
      </select>
    </div>
  </header>

  <nav class="tabs container" id="categoryTabs">
    <button data-cat="general" class="tab active">전체 공지</button>
    <button data-cat="event" class="tab">행사</button>
    <button data-cat="assessment" class="tab">수행평가</button>
    <button data-cat="class_notice" class="tab">반별 공지</button>
  </nav>

  <section class="container filters">
    <input id="searchInput" class="input" type="search" placeholder="제목+내용 검색" />
    <div id="assessmentFilter" class="row hidden">
      <label for="subjectSelect" class="label">과목</label>
      <select id="subjectSelect" class="select">
        <option value="all">전체</option>
        <option>국어</option><option>수학</option><option>영어</option>
        <option>통합사회</option><option>통합과학</option><option>한국사</option>
        <option>기술가정</option><option>한문</option><option>미술</option>
        <option>체육</option><option>과학탐구실험</option><option>기타</option>
      </select>
    </div>
  </section>

  <main class="container" id="list"></main>

  <!-- 이미지 모달 -->
  <div id="imgModal" class="modal hidden">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-content">
      <button id="modalClose" class="close">×</button>
      <img id="modalImg" alt="이미지" />
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, orderBy, getDocs,
      addDoc, updateDoc, deleteDoc, doc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjO0wwQQc8pDuQPurxVobABlKHAxDY2YA",
      authDomain: "jungwonjd2-1c79f.firebaseapp.com",
      projectId: "jungwonjd2-1c79f",
      storageBucket: "jungwonjd2-1c79f.firebasestorage.app",
      messagingSenderId: "962425903739",
      appId: "1:962425903739:web:de0c905dc285f566d3a0de",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const list = document.getElementById('list');
    const tabs = document.getElementById('categoryTabs');
    const classSelect = document.getElementById('classSelect');
    const searchInput = document.getElementById('searchInput');
    const subjectSelect = document.getElementById('subjectSelect');
    const assessmentFilter = document.getElementById('assessmentFilter');
    let currentCat = 'general';
    let classPwCache = {};

    const modal = document.getElementById('imgModal'), modalImg = document.getElementById('modalImg');
    document.getElementById('modalBackdrop').onclick=()=>modal.classList.add('hidden');
    document.getElementById('modalClose').onclick=()=>modal.classList.add('hidden');
    function openImg(url){ modalImg.src=url; modal.classList.remove('hidden'); }
    window.__openImg = openImg;

    function linkify(t){ return t.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>'); }
    function fmtDate(i){ if(!i) return ''; const d=new Date(i); return String(d.getFullYear()).slice(2)+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+String(d.getDate()).padStart(2,'0'); }

    // ── 캐러셀 ─────────────────────────────────────────
    function buildCarousel(p, imgs){
      const id = 'c'+p.id;
      let h = '<div class="img-carousel" id="'+id+'">'+
              '<img src="'+imgs[0]+'">'+
              '<button class="img-prev">‹</button>'+
              '<button class="img-next">›</button>'+
              '<div class="img-count">1 / '+imgs.length+'</div></div>';
      requestAnimationFrame(()=>{
        const box = document.getElementById(id); if(!box) return;
        const img = box.querySelector('img'), prev = box.querySelector('.img-prev'),
              next = box.querySelector('.img-next'), count = box.querySelector('.img-count');
        let i=0;
        function update(){
          img.src = imgs[i];
          prev.style.display = i===0?'none':'block';
          next.style.display = i===imgs.length-1?'none':'block';
          count.textContent = (i+1)+' / '+imgs.length;
        }
        prev.onclick = ()=>{ i=Math.max(0,i-1); update(); };
        next.onclick = ()=>{ i=Math.min(imgs.length-1,i+1); update(); };
        img.onclick  = ()=>openImg(imgs[i]);
        update();
      });
      return h;
    }
    function renderImages(p){
      const imgs = Array.isArray(p.imageUrls)&&p.imageUrls.length ? p.imageUrls : [p.imageUrl].filter(Boolean);
      if(!imgs.length) return '';
      if(imgs.length===1) return '<img class="card-img" src="'+imgs[0]+'" onclick="window.__openImg(\''+imgs[0]+'\')">';
      return buildCarousel(p, imgs);
    }

    // ── 데이터 가져오기 ─────────────────────────────────
    async function fetchPosts(){
      const cls = classSelect.value; const postsRef = collection(db, 'posts');
      let q;
      if(currentCat==='class_notice') q = query(postsRef, where('category','==','class_notice'), where('targetClass','==',cls), orderBy('createdAt','desc'));
      else if(currentCat==='general') q = query(postsRef, where('category','==','general'), orderBy('createdAt','desc'));
      else if(currentCat==='event') q = query(postsRef, where('category','==','event'), orderBy('eventDate','asc'));
      else if(currentCat==='assessment'){
        if(subjectSelect.value==='all') q = query(postsRef, where('category','==','assessment'), orderBy('createdAt','desc'));
        else q = query(postsRef, where('category','==','assessment'), where('subject','==',subjectSelect.value), orderBy('createdAt','desc'));
      }
      const s = await getDocs(q);
      return s.docs.map(d=>({id:d.id, ...d.data()}));
    }

    // ☆☆☆ (복구) 반별 일정 join ★☆☆
    async function attachClassSchedules(postId, base){
      const cls = classSelect.value;
      const ref = doc(db, `posts/${postId}/classSchedules/${cls}`);
      const snap = await getDoc(ref);
      base.classItems = snap.exists() ? (snap.data().items||[]) : [];
      return base;
    }
    function matchSchedule(n, classItems){
      return classItems.find(it => String(it.n)===String(n));
    }

    // ── 카드 렌더 ──────────────────────────────────────
    function card(p){
      const q = searchInput.value.trim().toLowerCase();
      if(q && !(`${p.title||''} ${p.content||''}`.toLowerCase().includes(q))) return '';

      const imgs = renderImages(p);
      const file = p.fileUrl ? '<a class="btn" href="'+p.fileUrl+'" download>파일 다운로드</a>' : '';

      if(p.category==='event'){
        return '<article class="card">'+
          '<h3>'+ (p.title||'') +'</h3>'+
          '<div class="muted">행사일: '+ fmtDate(p.eventDate) +'</div>'+
          '<p>'+ linkify(p.content||'').replace(/\n/g,'<br/>') +'</p>'+ imgs + file +
          '</article>';
      }

      if(p.category==='general' || p.category==='class_notice'){
        let h = '<article class="card" data-id="'+p.id+'">'+
          '<h3>'+ (p.title||'') +'</h3>'+
          '<p>'+ linkify(p.content||'').replace(/\n/g,'<br/>') +'</p>'+ imgs;
        if(currentCat==='class_notice'){
          h += '<div class="row end"><button class="btn small" data-edit="'+p.id+'">수정</button><button class="btn ghost small" data-del="'+p.id+'">삭제</button></div>';
        }
        return h + '</article>';
      }

      // ☆☆☆ (복구) 수행평가 카드 ★☆☆
      if(p.category==='assessment'){
        const schedules = Array.isArray(p.schedules)?p.schedules:[];
        const lines = schedules.map(sc=>{
          const hit = matchSchedule(sc.n, p.classItems||[]);
          const right = hit ? '<span class="pill">'+fmtDate(hit.date)+' '+hit.period+'교시</span>' : '';
          return '<div class="mono">'+sc.n+'차시 : '+(sc.text||'')+' '+right+'</div>';
        }).join('');
        const editUrl = './schedule-edit.html?post='+p.id;
        return '<article class="card">'+
          '<h3>'+ (p.title||'') +'</h3>'+
          '<p>'+ linkify(p.content||'').replace(/\n/g,'<br/>') +'</p>'+ imgs +
          '<div class="muted">일정</div><div>'+ lines +'</div>'+
          '<div class="row end"><a class="btn" href="'+editUrl+'">일정 수정</a>'+file+'</div>'+
          '</article>';
      }

      return '';
    }

    // ── 클래스 비번 검증 (반별 공지 작성/수정/삭제용) ──
    async function verifyClassPw(){
      const cls = classSelect.value;
      if(classPwCache[cls]) return true;
      const pw = prompt(`${cls}반 비밀번호를 입력하세요`);
      if(!pw) return false;
      const ref = doc(db, 'classPasswords', cls);
      const s = await getDoc(ref);
      if(!s.exists() || s.data().password !== pw){ alert('비밀번호가 올바르지 않습니다.'); return false; }
      classPwCache[cls] = true; return true;
    }

    // ── 탭/필터 ────────────────────────────────────────
    function setActiveTab(cat){
      [...tabs.querySelectorAll('.tab')].forEach(b=>b.classList.toggle('active', b.dataset.cat===cat));
      currentCat = cat;
      assessmentFilter.classList.toggle('hidden', cat!=="assessment");
      render();
    }
    tabs.onclick = e => { const b = e.target.closest('button[data-cat]'); if(b) setActiveTab(b.dataset.cat); };
    classSelect.onchange = render; searchInput.oninput = render; subjectSelect.onchange = render;

    // ── 렌더 ───────────────────────────────────────────
    async function render(){
      list.innerHTML = '<div class="muted">불러오는 중...</div>';
      let posts = await fetchPosts();

      // ☆☆☆ (복구) 수행평가일 때 반별 일정 join ★☆☆
      if(currentCat==='assessment'){
        for(let i=0;i<posts.length;i++){
          posts[i] = await attachClassSchedules(posts[i].id, posts[i]);
        }
      }

      let html = '';
      if(currentCat==='class_notice'){
        html += '<div id="newNoticeBox">'+
          '<h3>새 반별 공지 작성</h3>'+
          '<input id="newTitle" class="input" placeholder="제목" />'+
          '<textarea id="newContent" class="input" rows="4" placeholder="내용"></textarea>'+
          '<div class="row"><label>사진(여러 장)</label><input id="newImage" type="file" accept="image/*" multiple></div>'+
          '<button id="newSubmit" class="btn primary">게시</button></div>';
      }
      posts.forEach(p=> html += card(p));
      list.innerHTML = html || '<div class="empty">게시물이 없습니다.</div>';

      // 반별 공지 작성/삭제 버튼 바인딩 (기존 그대로)
      if(currentCat==='class_notice'){
        document.getElementById('newSubmit').onclick = async ()=>{
          if(!await verifyClassPw()) return;
          const title = document.getElementById('newTitle').value.trim();
          const content = document.getElementById('newContent').value.trim();
          const files = [...document.getElementById('newImage').files];

          if(!title || !content){ alert('제목과 내용을 입력하세요'); return; }

          // 이미지 다중 업로드(압축) — 기존 로직 유지
          const imgs = [];
          for(const f of files){
            const d = await (async function compressImage(file){
              if(!file) return null;
              return new Promise(r=>{
                const reader=new FileReader();
                reader.onload=e=>{
                  const img=new Image();
                  img.onload=()=>{
                    const c=document.createElement('canvas'),ctx=c.getContext('2d');
                    const s=Math.min(800/img.width,800/img.height,1);
                    c.width=img.width*s; c.height=img.height*s;
                    ctx.drawImage(img,0,0,c.width,c.height);
                    r(c.toDataURL('image/jpeg',0.7));
                  };
                  img.src=e.target.result;
                };
                reader.readAsDataURL(file);
              });
            })(f);
            if(d) imgs.push(d);
          }

          await addDoc(collection(db,'posts'),{
            title, content,
            category:'class_notice', targetClass:classSelect.value,
            imageUrls: imgs, imageUrl: imgs[0]||null,
            createdAt: serverTimestamp()
          });
          alert('게시 완료!'); render();
        };

        list.querySelectorAll('[data-del]').forEach(b=> b.onclick = async ()=>{
          if(!await verifyClassPw()) return;
          const id = b.dataset.del;
          if(confirm('삭제하시겠습니까?')){
            await deleteDoc(doc(db,'posts',id));
            alert('삭제 완료!'); render();
          }
        });
      }
    }

    // 초기 탭
    setActiveTab('general');
  </script>
</body>
</html>
