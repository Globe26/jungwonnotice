<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>중원고 1학년 공지 알리미</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .card {border:1px solid #ccc;border-radius:10px;padding:10px;margin-bottom:12px;}
    .card img {max-width:100%;border-radius:8px;margin-top:8px;}
    .btn.small{font-size:.85em;padding:4px 8px;margin-left:5px;}
    .edit-box{border:1px solid #ccc;padding:8px;border-radius:6px;margin-top:8px;}
    #newNoticeBox{border:1px solid #ddd;padding:10px;margin-bottom:10px;border-radius:8px;}
  </style>
</head>
<body>
  <header class="container">
    <h1>중원고 1학년 공지 알리미</h1>
    <div class="row">
      <label for="classSelect" class="label">반 선택</label>
      <select id="classSelect" class="select">
        <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
        <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
        <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
      </select>
    </div>
  </header>

  <nav class="tabs container" id="categoryTabs">
    <button data-cat="general" class="tab active">전체 공지</button>
    <button data-cat="event" class="tab">행사</button>
    <button data-cat="assessment" class="tab">수행평가</button>
    <button data-cat="class_notice" class="tab">반별 공지</button>
  </nav>

  <section class="container filters">
    <input id="searchInput" class="input" type="search" placeholder="제목+내용 검색" />
  </section>

  <main class="container" id="list"></main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, addDoc, updateDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjO0wwQQc8pDuQPurxVobABlKHAxDY2YA",
      authDomain: "jungwonjd2-1c79f.firebaseapp.com",
      projectId: "jungwonjd2-1c79f",
      storageBucket: "jungwonjd2-1c79f.firebasestorage.app",
      messagingSenderId: "962425903739",
      appId: "1:962425903739:web:de0c905dc285f566d3a0de",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tabs=document.getElementById('categoryTabs');
    const list=document.getElementById('list');
    const classSelect=document.getElementById('classSelect');
    const searchInput=document.getElementById('searchInput');
    let currentCat='general';
    let classPwCache={};

    // 🔗 URL 자동 링크 처리
    function linkify(text){
      const urlRegex=/(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex,'<a href="$1" target="_blank">$1</a>');
    }

    // 🖼️ 이미지 파일 base64 변환
    async function fileToBase64(file){
      if(!file) return null;
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>resolve(e.target.result);
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    function setActiveTab(cat){
      [...tabs.querySelectorAll('.tab')].forEach(b=>b.classList.toggle('active',b.dataset.cat===cat));
      currentCat=cat;
      render();
    }
    tabs.addEventListener('click',(e)=>{
      const b=e.target.closest('button[data-cat]');
      if(!b)return;
      setActiveTab(b.dataset.cat);
    });
    classSelect.addEventListener('change',render);
    searchInput.addEventListener('input',render);

    async function fetchPosts(){
      const postsRef=collection(db,'posts');
      let q;
      if(currentCat==='class_notice'){
        q=query(postsRef,where('category','==','class_notice'),where('targetClass','==',classSelect.value),orderBy('createdAt','desc'));
      }else{
        q=query(postsRef,where('category','==',currentCat),orderBy('createdAt','desc'));
      }
      const snap=await getDocs(q);
      return snap.docs.map(d=>({id:d.id,...d.data()}));
    }

    async function verifyClassPw(){
      const cls=classSelect.value;
      if(classPwCache[cls]) return true;
      const pw=prompt(`${cls}반 비밀번호를 입력하세요`);
      if(!pw)return false;
      const ref=doc(db,'classPasswords',cls);
      const snap=await getDoc(ref);
      if(!snap.exists()||snap.data().password!==pw){alert('비밀번호가 올바르지 않습니다.');return false;}
      classPwCache[cls]=true;
      return true;
    }

    async function render(){
      list.innerHTML='<div class="muted">불러오는 중...</div>';
      const posts=await fetchPosts();
      const q=searchInput.value.trim().toLowerCase();

      let html='';
      // 반별공지일 때 작성 박스 표시
      if(currentCat==='class_notice'){
        html+=`
        <div id="newNoticeBox">
          <h3>새 반별 공지 작성</h3>
          <input id="newTitle" class="input" placeholder="제목" />
          <textarea id="newContent" class="input" rows="4" placeholder="내용"></textarea>
          <div class="row"><label class="label">사진(선택)</label><input id="newImage" type="file" accept="image/*"></div>
          <button id="newSubmit" class="btn primary">게시</button>
          <div id="newMsg" class="muted"></div>
        </div>`;
      }

      posts.forEach(p=>{
        if(q){
          const hay=(p.title+p.content).toLowerCase();
          if(!hay.includes(q))return;
        }
        html+=`
        <article class="card" data-id="${p.id}">
          <h3>${p.title}</h3>
          <p>${linkify(p.content||'').replace(/\n/g,'<br>')}</p>
          ${p.imageUrl?`<img src="${p.imageUrl}" alt="">`:''}
          <div class="row end">
            ${currentCat==='class_notice'?`<button class="btn small" data-edit="${p.id}">수정</button>`:''}
          </div>
        </article>`;
      });
      list.innerHTML=html||'<div class="empty">게시물이 없습니다.</div>';

      // 작성 이벤트
      if(currentCat==='class_notice'){
        document.getElementById('newSubmit').addEventListener('click',async()=>{
          if(!await verifyClassPw())return;
          const title=document.getElementById('newTitle').value.trim();
          const content=document.getElementById('newContent').value.trim();
          const file=document.getElementById('newImage').files[0];
          if(!title||!content){alert('제목과 내용을 입력하세요');return;}
          const imgData=await fileToBase64(file);
          await addDoc(collection(db,'posts'),{
            title,content,category:'class_notice',
            targetClass:classSelect.value,
            imageUrl:imgData||null,
            createdAt:serverTimestamp()
          });
          alert('게시 완료!');
          render();
        });

        // 수정 기능
        list.querySelectorAll('[data-edit]').forEach(btn=>{
          btn.addEventListener('click',async()=>{
            if(!await verifyClassPw())return;
            const id=btn.dataset.edit;
            const card=btn.closest('.card');
            const t=card.querySelector('h3').textContent;
            const c=card.querySelector('p').textContent;

            card.innerHTML=`
              <div class="edit-box">
                <input id="editTitle" class="input" value="${t}">
                <textarea id="editContent" class="input">${c}</textarea>
                <div class="row"><label>사진(선택)</label><input id="editImage" type="file" accept="image/*"></div>
                <button id="saveBtn" class="btn primary">저장</button>
                <button id="cancelBtn" class="btn ghost">취소</button>
              </div>`;

            card.querySelector('#saveBtn').addEventListener('click',async()=>{
              const nt=card.querySelector('#editTitle').value.trim();
              const nc=card.querySelector('#editContent').value.trim();
              const nf=card.querySelector('#editImage').files[0];
              const img=await fileToBase64(nf);
              const payload={title:nt,content:nc,updatedAt:serverTimestamp()};
              if(img)payload.imageUrl=img;
              await updateDoc(doc(db,'posts',id),payload);
              alert('수정 완료!');
              render();
            });
            card.querySelector('#cancelBtn').addEventListener('click',()=>render());
          });
        });
      }
    }

    setActiveTab('general');
  </script>
</body>
</html>
