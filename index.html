<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>중원고 1학년 공지 알리미</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="container">
    <h1>중원고 1학년 공지 알리미</h1>
    <div class="row">
      <label for="classSelect" class="label">반 선택</label>
      <select id="classSelect" class="select">
        <option value="1">1반</option>
        <option value="2">2반</option>
        <option value="3">3반</option>
        <option value="4">4반</option>
        <option value="5">5반</option>
        <option value="6">6반</option>
        <option value="7">7반</option>
        <option value="8">8반</option>
        <option value="9">9반</option>
      </select>
    </div>
  </header>

  <nav class="tabs container" id="categoryTabs">
    <button data-cat="general" class="tab active">전체 공지</button>
    <button data-cat="event" class="tab">행사</button>
    <button data-cat="assessment" class="tab">수행평가</button>
    <button data-cat="class_notice" class="tab">반별 공지</button>
  </nav>

  <section class="container filters">
    <input id="searchInput" class="input" type="search" placeholder="제목+내용 검색" />

    <div id="assessmentFilter" class="row hidden">
      <label for="subjectSelect" class="label">과목</label>
      <select id="subjectSelect" class="select">
        <option value="all">전체</option>
        <option>국어</option>
        <option>수학</option>
        <option>영어</option>
        <option>통합사회</option>
        <option>통합과학</option>
        <option>한국사</option>
        <option>기술가정</option>
        <option>한문</option>
        <option>미술</option>
        <option>체육</option>
        <option>과학탐구실험</option>
        <option>기타</option>
      </select>
    </div>
  </section>

  <main class="container" id="list"></main>

  <!-- 이미지 모달 -->
  <div id="imgModal" class="modal hidden">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-content">
      <button id="modalClose" class="close">×</button>
      <img id="modalImg" alt="이미지" />
    </div>
  </div>

  <!-- Firebase SDK (모듈) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import {
      getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjO0wwQQc8pDuQPurxVobABlKHAxDY2YA",
      authDomain: "jungwonjd2-1c79f.firebaseapp.com",
      projectId: "jungwonjd2-1c79f",
      storageBucket: "jungwonjd2-1c79f.firebasestorage.app",
      messagingSenderId: "962425903739",
      appId: "1:962425903739:web:de0c905dc285f566d3a0de",
      measurementId: "G-7LKGCZKMFW"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // UI refs
    const tabs = document.getElementById('categoryTabs');
    const list = document.getElementById('list');
    const classSelect = document.getElementById('classSelect');
    const searchInput = document.getElementById('searchInput');
    const assessmentFilter = document.getElementById('assessmentFilter');
    const subjectSelect = document.getElementById('subjectSelect');

    let currentCat = 'general';

    function setActiveTab(cat){
      [...tabs.querySelectorAll('.tab')].forEach(b=>{
        b.classList.toggle('active', b.dataset.cat===cat);
      });
      currentCat = cat;
      assessmentFilter.classList.toggle('hidden', cat!=="assessment");
      render();
    }

    tabs.addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-cat]');
      if(!b) return;
      setActiveTab(b.dataset.cat);
    });

    classSelect.addEventListener('change', render);
    searchInput.addEventListener('input', render);
    subjectSelect.addEventListener('change', render);

    // 이미지 모달
    const modal = document.getElementById('imgModal');
    const modalImg = document.getElementById('modalImg');
    document.getElementById('modalBackdrop').addEventListener('click', ()=>modal.classList.add('hidden'));
    document.getElementById('modalClose').addEventListener('click', ()=>modal.classList.add('hidden'));

    function openImg(url){
      modalImg.src = url;
      modal.classList.remove('hidden');
    }

    function fmtDate(iso){
      if(!iso) return '';
      const d = new Date(iso);
      const yy = String(d.getFullYear()).slice(2);
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yy}.${mm}.${dd}`;
    }

    async function fetchPosts(){
      const postsRef = collection(db, 'posts');
      let q;
      const cls = classSelect.value;

      if(currentCat==='class_notice'){
        q = query(postsRef, where('category','==','class_notice'), where('targetClass','==',cls), orderBy('createdAt','desc'));
      } else if(currentCat==='general'){
        q = query(postsRef, where('category','==','general'), orderBy('createdAt','desc'));
      } else if(currentCat==='event'){
        q = query(postsRef, where('category','==','event'), orderBy('eventDate','asc'));
      } else if(currentCat==='assessment'){
        // 작성된 순서(최신 먼저)
        if(subjectSelect.value==='all'){
          q = query(postsRef, where('category','==','assessment'), orderBy('createdAt','desc'));
        } else {
          q = query(postsRef, where('category','==','assessment'), where('subject','==',subjectSelect.value), orderBy('createdAt','desc'));
        }
      }
      const snap = await getDocs(q);
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    }

    async function attachClassSchedules(postId, base){
      // classSchedules/{class}
      const cls = classSelect.value;
      const ref = doc(db, `posts/${postId}/classSchedules/${cls}`);
      const s = await getDoc(ref);
      if(s.exists()){
        base.classItems = s.data().items || [];
      } else {
        base.classItems = [];
      }
      return base;
    }

    function matchSchedule(n, classItems){
      return classItems.find(it=>String(it.n)===String(n));
    }

    function card(p){
      const q = searchInput.value.trim().toLowerCase();
      if(q){
        const hay = `${p.title||''} ${p.content||''}`.toLowerCase();
        if(!hay.includes(q)) return '';
      }

      const img = p.imageUrl ? `<img class="card-img" src="${p.imageUrl}" alt="image" onclick="window.__openImg('${p.imageUrl.replace(/'/g,"%27")}')" />` : '';
      const file = p.fileUrl ? `<a class="btn" href="${p.fileUrl}" download>파일 다운로드</a>` : '';

      if(p.category==='event'){
        return `
        <article class="card">
          <h3>${p.title||''}</h3>
          <div class="muted">행사일: ${fmtDate(p.eventDate)}</div>
          <p>${(p.content||'').replace(/\n/g,'<br/>')}</p>
          ${img}
          ${file}
        </article>`;
      }

      if(p.category==='general' || p.category==='class_notice'){
        return `
        <article class="card">
          <h3>${p.title||''}</h3>
          <p>${(p.content||'').replace(/\n/g,'<br/>')}</p>
          ${img}
          ${file}
        </article>`;
      }

      if(p.category==='assessment'){
        const schedules = Array.isArray(p.schedules) ? p.schedules : [];
        const lines = schedules.map(sc=>{
          const hit = matchSchedule(sc.n, p.classItems||[]);
          const right = hit ? `<span class="pill">${fmtDate(hit.date)} ${hit.period}교시</span>` : '';
          return `<div class="mono">${sc.n}차시 : ${sc.text||''} ${right}</div>`;
        }).join('');
        const editUrl = `./schedule-edit.html?post=${p.id}`;
        return `
        <article class="card">
          <h3>${p.title||''}</h3>
          <p>${(p.content||'').replace(/\n/g,'<br/>')}</p>
          ${img}
          <div class="muted">일정</div>
          <div>${lines}</div>
          <div class="row end">
            <a class="btn" href="${editUrl}">일정 수정</a>
            ${file}
          </div>
        </article>`;
      }
      return '';
    }

    window.__openImg = openImg; // inline handler에서 접근하도록

    async function render(){
      list.innerHTML = '<div class="skeleton">불러오는 중…</div>';
      const posts = await fetchPosts();

      // assessment는 반별 일정 join
      if(currentCat==='assessment'){
        for(let i=0;i<posts.length;i++){
          posts[i] = await attachClassSchedules(posts[i].id, posts[i]);
        }
      }

      const html = posts.map(card).filter(Boolean).join('');
      list.innerHTML = html || '<div class="empty">게시물이 없습니다.</div>';
    }

    // 초기 렌더
    setActiveTab('general');
  </script>
</body>
</html>