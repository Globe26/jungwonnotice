<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>중원고 1학년 공지 알리미</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="icon" type="image/svg+xml" href="./icon.svg" />
  <style>
    .card-img {max-width:100%;border-radius:8px;margin-top:8px;cursor:pointer;}
    .img-carousel {position:relative;max-width:100%;margin-top:8px;}
    .img-carousel img{width:100%;border-radius:8px;}
    .img-carousel button{
      position:absolute;top:50%;transform:translateY(-50%);
      background:rgba(0,0,0,0.5);color:white;border:none;
      padding:6px 10px;border-radius:50%;cursor:pointer;
    }
    .img-prev{left:8px;} .img-next{right:8px;}
    .img-count{position:absolute;bottom:5px;right:10px;
      background:rgba(0,0,0,0.5);color:white;padding:2px 6px;
      border-radius:6px;font-size:12px;}
    .btn.small{font-size:.85em;padding:4px 8px;margin-left:5px;}
    #newNoticeBox{border:1px solid #ccc;border-radius:10px;padding:10px;margin-bottom:12px;}
    .edit-box{border:1px solid #ccc;padding:8px;border-radius:6px;margin-top:8px;}
  </style>
</head>
<body>
  <header class="container">
    <img src="./icon.svg" alt="로고" style="height:40px;vertical-align:middle;margin-right:10px;">
    <h1 style="display:inline-block;vertical-align:middle;">중원고 1학년 공지 알리미</h1>
    <div class="row">
      <label for="classSelect" class="label">반 선택</label>
      <select id="classSelect" class="select">
        <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
        <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
        <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
      </select>
    </div>
  </header>

  <nav class="tabs container" id="categoryTabs">
    <button data-cat="general" class="tab active">전체 공지</button>
    <button data-cat="event" class="tab">행사</button>
    <button data-cat="assessment" class="tab">수행평가</button>
    <button data-cat="class_notice" class="tab">반별 공지</button>
  </nav>

  <section class="container filters">
    <input id="searchInput" class="input" type="search" placeholder="제목+내용 검색" />
    <div id="assessmentFilter" class="row hidden">
      <label for="subjectSelect" class="label">과목</label>
      <select id="subjectSelect" class="select">
        <option value="all">전체</option>
        <option>국어</option><option>수학</option><option>영어</option>
        <option>통합사회</option><option>통합과학</option><option>한국사</option>
        <option>기술가정</option><option>한문</option><option>미술</option>
        <option>체육</option><option>과학탐구실험</option><option>기타</option>
      </select>
    </div>
  </section>

  <main class="container" id="list"></main>

  <!-- 이미지 모달 -->
  <div id="imgModal" class="modal hidden">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-content">
      <button id="modalClose" class="close">×</button>
      <img id="modalImg" alt="이미지" />
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjO0wwQQc8pDuQPurxVobABlKHAxDY2YA",
      authDomain: "jungwonjd2-1c79f.firebaseapp.com",
      projectId: "jungwonjd2-1c79f",
      storageBucket: "jungwonjd2-1c79f.firebasestorage.app",
      messagingSenderId: "962425903739",
      appId: "1:962425903739:web:de0c905dc285f566d3a0de",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tabs=document.getElementById('categoryTabs');
    const list=document.getElementById('list');
    const classSelect=document.getElementById('classSelect');
    const searchInput=document.getElementById('searchInput');
    const assessmentFilter=document.getElementById('assessmentFilter');
    const subjectSelect=document.getElementById('subjectSelect');
    let currentCat='general';
    let classPwCache={};

    function linkify(text){
      const urlRegex=/(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex,'<a href="$1" target="_blank">$1</a>');
    }

    async function compressImage(file){
      if(!file) return null;
      return await new Promise(resolve=>{
        const reader=new FileReader();
        reader.onload=e=>{
          const img=new Image();
          img.onload=()=>{
            const canvas=document.createElement('canvas');
            const ctx=canvas.getContext('2d');
            const scale=Math.min(800/img.width,800/img.height,1);
            canvas.width=img.width*scale;
            canvas.height=img.height*scale;
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
            resolve(canvas.toDataURL('image/jpeg',0.7));
          };
          img.src=e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    const modal=document.getElementById('imgModal');
    const modalImg=document.getElementById('modalImg');
    document.getElementById('modalBackdrop').addEventListener('click',()=>modal.classList.add('hidden'));
    document.getElementById('modalClose').addEventListener('click',()=>modal.classList.add('hidden'));
    function openImg(url){ modalImg.src=url; modal.classList.remove('hidden'); }
    window.__openImg=openImg;

    function setActiveTab(cat){
      [...tabs.querySelectorAll('.tab')].forEach(b=>b.classList.toggle('active',b.dataset.cat===cat));
      currentCat=cat;
      assessmentFilter.classList.toggle('hidden',cat!=="assessment");
      render();
    }
    tabs.addEventListener('click',(e)=>{
      const b=e.target.closest('button[data-cat]');
      if(!b)return;
      setActiveTab(b.dataset.cat);
    });
    classSelect.addEventListener('change',render);
    searchInput.addEventListener('input',render);
    subjectSelect.addEventListener('change',render);

    async function fetchPosts(){
      const postsRef=collection(db,'posts');
      const cls=classSelect.value;
      let q;
      if(currentCat==='class_notice'){
        q=query(postsRef,where('category','==','class_notice'),where('targetClass','==',cls),orderBy('createdAt','desc'));
      }else if(currentCat==='general'){
        q=query(postsRef,where('category','==','general'),orderBy('createdAt','desc'));
      }else if(currentCat==='event'){
        q=query(postsRef,where('category','==','event'),orderBy('eventDate','asc'));
      }else if(currentCat==='assessment'){
        if(subjectSelect.value==='all'){
          q=query(postsRef,where('category','==','assessment'),orderBy('createdAt','desc'));
        }else{
          q=query(postsRef,where('category','==','assessment'),where('subject','==',subjectSelect.value),orderBy('createdAt','desc'));
        }
      }
      const snap=await getDocs(q);
      return snap.docs.map(d=>({id:d.id,...d.data()}));
    }

    async function attachClassSchedules(postId,base){
      const cls=classSelect.value;
      const ref=doc(db,`posts/${postId}/classSchedules/${cls}`);
      const s=await getDoc(ref);
      base.classItems=s.exists()?s.data().items||[]:[];
      return base;
    }

    function matchSchedule(n,classItems){return classItems.find(it=>String(it.n)===String(n));}

    async function verifyClassPw(){
      const cls=classSelect.value;
      if(classPwCache[cls])return true;
      const pw=prompt(`${cls}반 비밀번호를 입력하세요`);
      if(!pw)return false;
      const ref=doc(db,'classPasswords',cls);
      const snap=await getDoc(ref);
      if(!snap.exists()||snap.data().password!==pw){alert('비밀번호가 올바르지 않습니다.');return false;}
      classPwCache[cls]=true;
      return true;
    }

    function fmtDate(iso){
      if(!iso)return'';
      const d=new Date(iso);
      const yy=String(d.getFullYear()).slice(2);
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      return `${yy}.${mm}.${dd}`;
    }

    function renderImages(p){
      const imgs=Array.isArray(p.imageUrls)&&p.imageUrls.length>0?p.imageUrls:[p.imageUrl].filter(Boolean);
      if(!imgs.length)return'';
      if(imgs.length===1){
        return '<img class="card-img" src="'+imgs[0]+'" alt="img" onclick="window.__openImg(\''+imgs[0].replace(/'/g,"%27")+'\')">';
      }
      const id='carousel-'+p.id;
      let out='<div class="img-carousel" id="'+id+'">'+
              '<img src="'+imgs[0]+'" alt="img">'+
              '<button class="img-prev">‹</button>'+
              '<button class="img-next">›</button>'+
              '<div class="img-count">1 / '+imgs.length+'</div></div>'+
              '<script>(function(){const box=document.getElementById("'+id+'");const img=box.querySelector("img");const prev=box.querySelector(".img-prev");const next=box.querySelector(".img-next");const count=box.querySelector(".img-count");const arr='+JSON.stringify(imgs)+';let i=0;function update(){img.src=arr[i];count.textContent=(i+1)+" / "+arr.length;}prev.onclick=()=>{i=(i-1+arr.length)%arr.length;update();};next.onclick=()=>{i=(i+1)%arr.length;update();};img.onclick=()=>window.__openImg(arr[i]);})();<\/script>';
      return out;
    }

    function card(p){
      const q=searchInput.value.trim().toLowerCase();
      if(q){
        const hay=(p.title||'')+' '+(p.content||'');
        if(!hay.toLowerCase().includes(q))return'';
      }
      const imgs=renderImages(p);
      const file=p.fileUrl?'<a class="btn" href="'+p.fileUrl+'" download>파일 다운로드</a>':'';
      if(p.category==='event'){
        return '<article class="card"><h3>'+p.title+'</h3><div class="muted">행사일: '+fmtDate(p.eventDate)+'</div><p>'+linkify(p.content||'').replace(/\n/g,'<br/>')+'</p>'+imgs+file+'</article>';
      }
      if(p.category==='general'||p.category==='class_notice'){
        let base='<article class="card" data-id="'+p.id+'"><h3>'+p.title+'</h3><p>'+linkify(p.content||'').replace(/\n/g,'<br/>')+'</p>'+imgs;
        if(currentCat==='class_notice'){
          base+='<div class="row end"><button class="btn small" data-edit="'+p.id+'">수정</button><button class="btn ghost small" data-del="'+p.id+'">삭제</button></div>';
        }
        base+='</article>';
        return base;
      }
      if(p.category==='assessment'){
        const schedules=Array.isArray(p.schedules)?p.schedules:[];
        let lines='';
        for(const sc of schedules){
          const hit=matchSchedule(sc.n,p.classItems||[]);
          const right=hit?'<span class="pill">'+fmtDate(hit.date)+' '+hit.period+'교시</span>':'';
          lines+='<div class="mono">'+sc.n+'차시 : '+(sc.text||'')+' '+right+'</div>';
        }
        const editUrl='./schedule-edit.html?post='+p.id;
        return '<article class="card"><h3>'+p.title+'</h3><p>'+linkify(p.content||'').replace(/\n/g,'<br/>')+'</p>'+imgs+'<div class="muted">일정</div><div>'+lines+'</div><div class="row end"><a class="btn" href="'+editUrl+'">일정 수정</a>'+file+'</div></article>';
      }
      return'';
    }

    async function render(){
      list.innerHTML='<div class="muted">불러오는 중...</div>';
      const posts=await fetchPosts();
      if(currentCat==='assessment'){
        for(let i=0;i<posts.length;i++){
          posts[i]=await attachClassSchedules(posts[i].id,posts[i]);
        }
      }
      let html='';
      if(currentCat==='class_notice'){
        html+='<div id="newNoticeBox"><h3>새 반별 공지 작성</h3><input id="newTitle" class="input" placeholder="제목" /><textarea id="newContent" class="input" rows="4" placeholder="내용"></textarea><div class="row"><label>사진(선택, 여러 장)</label><input id="newImage" type="file" accept="image/*" multiple></div><button id="newSubmit" class="btn primary">게시</button></div>';
      }
      for(const p of posts){html+=card(p);}
      list.innerHTML=html||'<div class="empty">게시물이 없습니다.</div>';

      if(currentCat==='class_notice'){
        document.getElementById('newSubmit').addEventListener('click',async()=>{
          if(!await verifyClassPw())return;
          const title=document.getElementById('newTitle').value.trim();
          const content=document.getElementById('newContent').value.trim();
          const files=[...document.getElementById('newImage').files];
          if(!title||!content){alert('제목과 내용을 입력하세요');return;}
          const imgs=[];
          for(const f of files){const d=await compressImage(f);if(d)imgs.push(d);}
          await addDoc(collection(db,'posts'),{
            title,content,category:'class_notice',targetClass:classSelect.value,
            imageUrls:imgs,imageUrl:imgs[0]||null,createdAt:serverTimestamp()
          });
          alert('게시 완료!');render();
        });

        list.querySelectorAll('[data-edit]').forEach(btn=>{
          btn.addEventListener('click',async()=>{
            if(!await verifyClassPw())return;
            const id=btn.dataset.edit;
            const card=btn.closest('.card');
            const t=card.querySelector('h3').textContent;
            const c=card.querySelector('p').textContent;
            card.innerHTML='<div class="edit-box"><input id="editTitle" class="input" value="'+t+'"><textarea id="editContent" class="input">'+c+'</textarea><div class="row"><label>사진(선택, 여러 장)</label><input id="editImage" type="file" accept="image/*" multiple></div><button id="saveBtn" class="btn primary">저장</button><button id="cancelBtn" class="btn ghost">취소</button></div>';
            card.querySelector('#saveBtn').addEventListener('click',async()=>{
              const nt=card.querySelector('#editTitle').value.trim();
              const nc=card.querySelector('#editContent').value.trim();
              const files=[...card.querySelector('#editImage').files];
              const imgs=[];
              for(const f of files){const d=await compressImage(f);if(d)imgs.push(d);}
              const payload={title:nt,content:nc,updatedAt:serverTimestamp()};
              if(imgs.length){payload.imageUrls=imgs;payload.imageUrl=imgs[0];}
              await updateDoc(doc(db,'posts',id),payload);
              alert('수정 완료!');render();
            });
            card.querySelector('#cancelBtn').addEventListener('click',()=>render());
          });
        });

        list.querySelectorAll('[data-del]').forEach(btn=>{
          btn.addEventListener('click',async()=>{
            if(!await verifyClassPw())return;
            const id=btn.dataset.del;
            if(confirm('정말 삭제하시겠습니까?')){
              await deleteDoc(doc(db,'posts',id));
              alert('삭제 완료!');render();
            }
          });
        });
      }
    }

    setActiveTab('general');
  </script>
</body>
</html>
